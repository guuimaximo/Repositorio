name: ETL Pipeline (Athena to Supabase)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1' 
  push:
    branches: [ main ]
    paths:
      - 'pipeline/**'
      - 'requirements.txt'

jobs:
  run-etl:
    runs-on: ubuntu-latest
    
    environment: production 

    steps:
    - name: ‚¨áÔ∏è Checkout do C√≥digo
      uses: actions/checkout@v4

    - name: üêç Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: üì¶ Instalar Depend√™ncias
      run: pip install -r requirements.txt

    - name: üèÉ Rodar Pipeline ETL
      env:
        # Credenciais AWS (Chaves devem continuar como secrets!)
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        
        # VARI√ÅVEIS FIXAS CORRIGIDAS (Sem a sintaxe ${{ }})
        AWS_REGION: us-east-1
        ATHENA_S3_STAGING_DIR: s3://csc-athena-query-results/
        DESTINATION_TABLE_NAME: motoristas 
        
        # Vari√°veis do Supabase (Devem continuar como secrets!)
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_API_KEY: ${{ secrets.SUPABASE_API_KEY }}
        
      run: python pipeline/etl_motorista_athena.py